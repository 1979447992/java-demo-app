name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package -DskipTests
    
    - name: Build Docker image
      run: |
        IMAGE_TAG=47.83.206.116:30002/library/demo-app:$(date +%Y%m%d-%H%M%S)
        docker build -t $IMAGE_TAG .
        echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
    
    - name: Push to Harbor
      run: |
        docker login 47.83.206.116:30002 -u ${{ secrets.HARBOR_USERNAME }} -p ${{ secrets.HARBOR_PASSWORD }}
        docker push $IMAGE_TAG
        #        docker login 47.83.206.116:30002 -u admin -p Harbor12345
        # docker login --insecure-registry 47.83.206.116:30002 -u admin -p Harbor12345
        # docker push $IMAGE_TAG
    
    - name: Update deployment config
      run: |
        git clone https://github.com/1979447992/k8s-config-repo.git
        cd k8s-config-repo
        sed -i "s|image: 47.83.206.116:30002/library/demo-app:.*|image: $IMAGE_TAG|g" demo-app/deployment.yaml
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add .
        git commit -m "Update image to $IMAGE_TAG"
        git push https://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@github.com/1979447992/k8s-config-repo.git



