name: CI/CD Pipeline

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Build with Maven
      run: mvn clean package
    
    - name: Configure Docker for insecure registry
      run: |
        # 停止 Docker 服务
        sudo systemctl stop docker
        
        # 创建或更新 daemon.json
        sudo mkdir -p /etc/docker
        echo '{
          "insecure-registries": ["47.83.206.116:30002"]
        }' | sudo tee /etc/docker/daemon.json
        
        # 启动 Docker 服务
        sudo systemctl start docker
        
        # 等待 Docker 完全启动
        sleep 10
        
        # 验证配置
        sudo systemctl status docker
        docker info | grep -A 10 "Insecure Registries"
    
    - name: Configure Docker and Login to Harbor
      run: |
        echo "=== Configure insecure registry ==="
        sudo mkdir -p /etc/docker
        echo '{"insecure-registries":["47.83.206.116:30002"]}' | sudo tee /etc/docker/daemon.json
        
        echo "=== Restart Docker ==="
        sudo systemctl restart docker
        sleep 20
        
        echo "=== Verify Docker configuration ==="
        docker info | grep -A 5 "Insecure Registries" || echo "No insecure registries found"
        
        echo "=== Test Harbor connectivity ==="
        curl -f http://47.83.206.116:30002/v2/ || echo "Expected unauthorized response"
        
        echo "=== Login to Harbor ==="
        echo "${{ secrets.HARBOR_PASSWORD }}" | docker login 47.83.206.116:30002 -u "${{ secrets.HARBOR_USERNAME }}" --password-stdin
        
        echo "=== Verify login success ==="
        docker info | grep -A 10 "Registry"
    
    - name: Build and Push Docker Image
      run: |
        docker build -t 47.83.206.116:30002/library/demo-app:${{ github.sha }} .
        docker push 47.83.206.116:30002/library/demo-app:${{ github.sha }}
